    <!DOCTYPE html>
    <html>
        <head>
            <title>wssccc</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta charset="utf-8">
            <!-- Bootstrap -->
            <link rel="stylesheet" href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css">
            <link rel="stylesheet" href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap-theme.min.css">
            <link rel="stylesheet" href="../../../assets/css/custom.css">
            <!-- Favicon -->
            <link rel="shortcut icon" href="../../../assets/img/icon.png" />
            <link rel="favicon" href="../../../assets/img/icon.png" />
            <link rel="bookmark" href="../../../assets/img/icon.png" />
            <!--syntax hilighter-->
            <link rel="stylesheet" href="../../../assets/sh/styles/shCore.css">
            <link rel="stylesheet" href="../../../assets/sh/styles/shThemeDefault.css">
            <script src="../../../assets/sh/scripts/shCore.js"></script>
            <script src="../../../assets/sh/scripts/shBrushJScript.js"></script>
            <script src="../../../assets/sh/scripts/shBrushJava.js"></script>
            <script src="../../../assets/sh/scripts/shBrushXml.js"></script>

            <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
            <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
            <!--[if lt IE 9]>
                <script src="http://cdn.bootcss.com/html5shiv/3.7.0/html5shiv.min.js"></script>
                <script src="http://cdn.bootcss.com/respond.js/1.3.0/respond.min.js"></script>
            <![endif]-->

            <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
            <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
        </head>
        <body style="padding-top: 20px">
            <div class="container">
                <div class="site-heading-container">
                    <a class="site-heading" href="../../../">wssccc in action</a>
                    <a href="../../..//blog/rss.xml" rel="subscribe-rss" title="subscribe via RSS"><img src="../../../assets/img/atom.png" class="pull-right no-fix-img"></a>
                </div>
                    <div>
        <ol class="breadcrumb">
            <li><a href="../../../">wssccc</a></li>
            <li><a href="../../archives/1/">archive</a></li>
            <li><a href="#">post</a></li>
        </ol>
    </div>
    <div id="posts" class="container">
        <div class="post">
            <div>
                <a href="index.html" class="post-heading">ngscript之二：语法分析</a>
                <span class="time pull-right">2014-03-06 19:07</span>
                <hr/>
            </div>
            <div class="post-content">
                <p>ngscript的语法分析使用的是我自己的语法分析工具<a href="https://github.com/wssccc/parseroid.git">parseroid</a>。与常用cc工具（yacc、bison、javacc、antlr、etc…）不同的是，parseroid生成的不是语法分析器的源程序，而是一个parser对象，直接可以用来执行parsing。也就是说，可以由BNF在执行阶段动态生成parser。</p>

<p>生成parser的action table运算量还是有点大，所以在新版的parseroid里面table改成了serializable的，可以缓存下来免去生成table的过程。</p>

<h2>实现parseroid</h2>

<h3>文法描述</h3>

<p>parseroid使用LALR(1)文法。</p>

<p>parseroid使用的文法描述文件是这个样子</p>

<pre><code>//starter symbol 

%start &lt;program&gt;;

%array &lt;statements&gt; &lt;param_list&gt; &lt;params&gt;;

%equiv &lt;expr&gt; &lt;expr1&gt; &lt;expr2&gt; &lt;expr3&gt; &lt;expr4&gt; &lt;expr5&gt; &lt;expr6&gt; &lt;expr7&gt; &lt;expr8&gt; &lt;nullable_expr&gt;;

%filter semicolon comma;



&lt;program&gt; ::= &lt;statements&gt;;

//----------------------------------------------------------------------------

//statements is a collection of statement;

&lt;statements&gt; ::= NULL;

&lt;statements&gt; ::= &lt;statement&gt; &lt;statements&gt;;

//省略一些

&lt;throw_exception&gt; ::= throw &lt;expr&gt; semicolon =&gt; &lt;expr&gt;;

//再省略一些
</code></pre>

<p>%开头的是注记，有这几种</p>

<ul>
<li><p>%start 指定一个起始符</p></li>
<li><p>%equiv 标记等价类，在生成语法树之后的reduce过程中，会把等价类合并</p></li>
<li><p>%filter 也是在reduce过程中，会把这些节点去掉</p></li>
<li><p>=> 标记的用处是在规约生成语法树的时候调整AST，如这句 <code>&lt;throw_exception&gt; ::= throw &lt;expr&gt; semicolon =&gt; &lt;expr&gt;;</code> <br/>这句的意思是用throw <expr> semicolon的结构规约到<throw_exception>，但是只保存<expr>这个元素，主要是为了后面处理语法树方便和看起来更加顺眼……</p></li>
</ul>

<h3>实现</h3>

<p>LALR（1）的具体细节书本上都有，就不再阐述了。</p>

<h3>错误恢复</h3>

<p>parseroid使用error符号错误恢复。</p>

<p>具体做法是写这样的产生式<code>&lt;statements&gt; ::= error semicolon &lt;statements&gt;;</code></p>

<p>效果是，在遇到statements中的错误之后，会把错误部分parsing为一个error节点，然后同步到semicolon的位置继续parsing。</p>

<p>具体过程</p>

<p>-不断的弹出栈顶，直到一个特定的状态，在该状态中error符号的动作为移进。</p>

<p>-移进error符号</p>

<p>-不断丢弃输入符号，直到一个特定的向前查看符号，它在当前状态，对应一个非出错的动作。</p>

<p>-重新开始正常分析</p>

<h3>语法树简化</h3>

<p>*合并等价类</p>

<p>*删除无用的嵌套</p>

<p>*删除不必要的节点</p>

<p>合并等价类是因为在parseroid的文法描述中，没有显式指定算符的优先级，需要使用产生式的层次来表现。</p>

<p>于是就有很多<code>&lt;expr1&gt;</code> <code>&lt;expr2&gt;</code>这种东西，但是他们实质上都可以当成expr来处理。</p>

<p>无用的嵌套是因为在<code>&lt;expr1&gt;</code>这种化为<code>&lt;expr&gt;</code>之后，可能出现如<code>&lt;expr&gt; -&gt; &lt;expr&gt; -&gt; number</code>这种，也是可以简化的。</p>

<p>不必要的节点，就是左括号右括号这种。</p>

<p>parseroid源代码在这里</p>

<p><a href="https://github.com/wssccc/parseroid.git">https://github.com/wssccc/parseroid.git</a></p>

<p>后面我会用lexeroid和parseroid实现ngscript的解析器。</p>

<h2>其它分析方法的介绍</h2>

<p>语法分析的方法有很多，简单介绍一下。</p>

<h3>SLR(1)</h3>

<p>编译原理的大作业就是实现SLR（1），可以处理这样的文法</p>

<pre><code>S-&gt;# Ee #

Ee-&gt;Ee + Ti|Ee - Ti|Ti

Ti-&gt;Ti * Ff|Ti / Ff|Ff

Ff-&gt;( Ee )|d

Ff-&gt;sin Ff

Ff-&gt;cos Ff
</code></pre>

<p>当时觉得只要文法改改就能用，后来真正用的时候才发现是个坑……</p>

<p>书上是把它当过渡方法来讲的</p>

<h3>Parser组合子</h3>

<p>最开始知道这个是在</p>

<p>这里 <a href="http://www.cnblogs.com/Ninputer/archive/2011/06/26/2090645.html">自己动手开发编译器（八）用Linq编写解析器组合子</a></p>

<p>这里 <a href="http://www.ibm.com/developerworks/cn/java/j-lo-compose/">利用 Java 实现组合式解析器</a></p>

<p>还有这里 <a href="http://www.cnblogs.com/Ninputer/archive/2011/07/03/2096944.html">自己动手开发编译器（九）CPS风格的解析器组合子</a></p>

<p>我也用Java实现了一个，因为Java没有lambda，硬是用匿名类整了出来。也是CPS的，带错误恢复。</p>

<p>运行起来大概是这样</p>

<p><img src="java-cps-parser.jpg" alt="java-cps-parser.jpg" /></p>

<p>不过解析器组合子的缺点也很明显，就是太难调试了。而且文法是用代码的形式在程序中描述的，太复杂之后我就被绕晕了 = =</p>

<h3>LL（1）</h3>

<p>LL（1）应该算是比较容易实现的，不过需要对文法做一些调整，消除左递归，提取左公因式什么的，后来写到二元运算符的文法我还是觉得LL（1）不能忍。</p>

<h3>LALR（1）</h3>

<p>书上介绍分析方法的顺序LALR（1）一般是排在最后的，按这种设定应该是这个最靠谱了。</p>

<p>附一张图：</p>

<p><img src="grammar-cascade.jpg" alt="grammar-cascade.jpg" /></p>
            </div>
            <hr/>
            <div class="">
                <p>Tags: 
                                            <a class="tag_a" href="../../tags/ngscript.html">ngscript</a>
                                                <a class="tag_a" href="../../tags/E8AFADE6B395E58886E69E90.html">语法分析</a>
                                                <a class="tag_a" href="../../tags/E8AFADE8A880.html">语言</a>
                                                <a class="tag_a" href="../../tags/E7BC96E8AF91E599A8.html">编译器</a>
                                        </p>
            </div>
            <!-- JiaThis Button BEGIN -->
            <div class="jiathis_style">
                <a class="jiathis_button_tsina"></a>
                <a class="jiathis_button_tqq"></a>
                <a class="jiathis_button_weixin"></a>
                <a class="jiathis_button_renren"></a>
                <a class="jiathis_button_douban"></a>
                <a class="jiathis_button_fb"></a>
                <a class="jiathis_button_googleplus"></a>
                <a class="jiathis_button_twitter"></a>
                <a class="jiathis_button_qzone"></a>
                <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank">更多</a>
            </div>
            <script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1394078030301326" charset="utf-8"></script>
            <!-- JiaThis Button END -->
        </div>
    </div>
    <div class="">
        <ul class="pager">
            <li class="pull-left"><a id="pre-post-archor" href="#">上一篇： <span id="pre-post-title"></span></a></li>
            <li class="pull-right"><a id="next-post-archor" href="#">下一篇： <span id="next-post-title"></span></a></li>
        </ul>
        <script>
            $(document).ready(function()
            {
                $.getJSON('../indexer.json', null, function(data)
                {
                    if (data instanceof Array)
                    {
                        for (i = 0; i < data.length; i++) {
                            if (data[i].sname === 'ngscript-part-3')
                            {
                                if (i !== 0)
                                {
                                    $('#pre-post-archor').attr('href', data[i - 1].url);
                                    $('#pre-post-title').text(data[i - 1].title);
                                } else {
                                    $('#pre-post-title').text('没有了');
                                }
                                if (i !== data.length - 1)
                                {
                                    $('#next-post-archor').attr('href', data[i + 1].url);
                                    $('#next-post-title').text(data[i + 1].title);
                                } else {
                                    $('#next-post-title').text('没有了');
                                }
                            }
                        }
                    }
                });
            });
        </script>
    </div>
    <div style="margin-left: 0px;">
        <!-- Duoshuo Comment BEGIN -->
        <div class="ds-thread" data-thread-key="ngscript-part-3/" data-title="ngscript之二：语法分析"></div>
        <script type="text/javascript">
            var duoshuoQuery = {short_name: "wssccc"};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';
                ds.async = true;
                ds.src = 'http://static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0]
                        || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
        </script>
        <!-- Duoshuo Comment END -->
    </div>
                    <hr/>
                <div class="footer">
                    <p>Copyright &COPY;<a href="../../../blog/pages/about/">wssccc</a> 2013 using <a href="../../../blog/pages/about-generator/">wsc_blog_generator</a> <a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/deed.zh"><img class="no-fix-img" alt="知识共享许可协议" style="border-width:0" src="../../../assets/img/80x15.png" /></a></p>
                    <p>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/deed.zh">知识共享署名-禁止演绎 3.0 未本地化版本许可协议</a>进行许可。</p>
                </div>
            </div>
            <!-- Include all compiled plugins (below), or include individual files as needed -->
            <script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
            <script>
                $(document).ready(function() {
                    $('img').each(function()
                    {
                        if ($(this).hasClass('no-fix-img'))
                        {
                            return;
                        }
                        var src = $(this).attr('src');
                        if (src.match("http://") === null)
                        {
                            var real_url = '../../../blog/images/' + src;
                            $(this).attr('src', real_url);
                            $(this).addClass('user-image');
                            var archor = $('<a>');
                            archor.attr('href', real_url);
                            archor.attr('target', '_blank');

                            archor.insertBefore($(this));
                            $(this).appendTo(archor);
                        }
                    });

                });
            </script>
            <script>
                SyntaxHighlighter.all();
            </script>
        </body>
    </html>
    