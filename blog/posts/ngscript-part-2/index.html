    <!DOCTYPE html>
    <html>
        <head>
            <title>wssccc</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta charset="utf-8">
            <!-- Bootstrap -->
            <link rel="stylesheet" href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css">
            <link rel="stylesheet" href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap-theme.min.css">
            <link rel="stylesheet" href="../../../assets/css/custom.css">
            <!-- Favicon -->
            <link rel="shortcut icon" href="../../../assets/img/icon.png" />
            <link rel="favicon" href="../../../assets/img/icon.png" />
            <link rel="bookmark" href="../../../assets/img/icon.png" />
            <!--syntax hilighter-->
            <link rel="stylesheet" href="../../../assets/sh/styles/shCore.css">
            <link rel="stylesheet" href="../../../assets/sh/styles/shThemeDefault.css">
            <script src="../../../assets/sh/scripts/shCore.js"></script>
            <script src="../../../assets/sh/scripts/shBrushJScript.js"></script>
            <script src="../../../assets/sh/scripts/shBrushJava.js"></script>
            <script src="../../../assets/sh/scripts/shBrushPhp.js"></script>
            <script src="../../../assets/sh/scripts/shBrushXml.js"></script>

            <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
            <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
            <!--[if lt IE 9]>
                <script src="http://cdn.bootcss.com/html5shiv/3.7.0/html5shiv.min.js"></script>
                <script src="http://cdn.bootcss.com/respond.js/1.3.0/respond.min.js"></script>
            <![endif]-->

            <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
            <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
        </head>
        <body style="">
            <!--wp header--> 
            <header id="masthead" class="site-header" role="banner">
                <a class="home-link" href="../../../" title="wssccc in action" rel="home">
                    <h1 class="site-title">wssccc in action</h1>
                    <h2 class="site-description"></h2>
                </a>
            </header>
            <!--wp header--> 
            <div class="container">
                <div class="site-rss-container">
                    <a href="../../..//blog/rss.xml" rel="subscribe-rss" title="subscribe via RSS"><img src="../../../assets/img/atom.png" class="pull-right no-fix-img"></a>
                </div>
                    <div>
        <ol class="breadcrumb">
            <li><a href="../../../">wssccc</a></li>
            <li><a href="../../archives/1/">archive</a></li>
            <li><a href="#">post</a></li>
        </ol>
    </div>
    <div id="posts" class="container">
        <div class="post">
            <div>
                <a href="index.html" class="post-heading">ngscript之一：词法分析</a>
                <span class="time pull-right">2014-03-04 13:35</span>
            </div>
            <div class="post-content">
                <p>正则表达式的理论基础可以参考<a href="http://home.cnblogs.com/u/Ninputer/">装配脑袋</a>的</p>

<ul>
<li><p>这个 <a href="http://www.cnblogs.com/Ninputer/archive/2011/06/08/2075714.html">自己动手开发编译器（二）正则语言和正则表达式</a></p></li>
<li><p>这个 <a href="http://www.cnblogs.com/Ninputer/archive/2011/06/10/2077991.html">自己动手开发编译器（三）有穷自动机</a></p></li>
<li><p>还有这个 <a href="http://www.cnblogs.com/Ninputer/archive/2011/06/12/2078671.html">自己动手开发编译器（四）利用DFA转换表建立扫描器</a></p></li>
</ul>

<p>如果学过编译原理的课程就更好了。</p>

<p>词法分析用到了我写的一个工具lexeroid。</p>

<p>下面说一些我写lexeroid时候遇到的问题。</p>

<h2>Unicode</h2>

<p>在装配脑袋的<a href="http://www.cnblogs.com/Ninputer/archive/2011/06/12/2078671.html">自己动手开发编译器（四）利用DFA转换表建立扫描器</a> 中，提到了等价类处理Unicode的方法。</p>

<p>我做了一些改进。</p>

<p>在lexeroid中，所有的已定义字符都会注册，等Regex定义完成，开始生成DFA之前，会把所有的Any转换为undefined和每个已注册类。</p>

<p>如果定义的逻辑是not，则会在替换的时候排除掉这些字符。</p>

<p>这样就没有lexeroid之前的冲突处理过程了。 </p>

<h2>最长匹配</h2>

<p>这个很多书上应该介绍过，就是设置一个lastFinal一样的东西，然后在DFA停机的时候把最后一个正确匹配的取出来。</p>

<h2>NFA的组织</h2>

<p>最开始我做的是把每个token的NFA分开，存成一个数组，然后每个生成DFA之后，在词法分析的时候一个一个去测试。后来发现这个似乎和用Java内置的正则表达式没什么区别。而且有一个问题是，token定义的顺序要十分小心，因为先定义的token会被优先匹配到。</p>

<p>后来我试了另外一种方法，就是等所有token生成NFA完之后，添加一个入口，用epsilon边把所有的NFA连起来形成一个大NFA，然后再用它生成的DFA去匹配。</p>

<h2>最后</h2>

<p>lexeroid定义token时大概是这个样子(目前lexeroid已经支持从字符串parse出Regex)</p>

<pre class="brush: java">

    LexerBuilder builder = new LexerBuilder();

    builder.defineToken("if", Re.string("if"));

    builder.defineToken("return", Re.string("return"));

    builder.defineToken("else", Re.string("else"));

    builder.defineToken("ident", Re.concat(

            Re.or(Re.letter(), Re.chr('_')),

            Re.many(Re.or(Re.or(Re.letter(), Re.chr('_')), Re.digit()))

    ));

    builder.defineToken("string",

            Re.concat(Re.chr('"'), Re.many(Re.char1()), Re.chr('"'))

    );



      //此处省略N行

      return builder.build();

</pre>

<p>代码可以从这里找到</p>

<p><a href="https://github.com/wssccc/lexeroid.git">https://github.com/wssccc/lexeroid.git</a></p>

<p>作为一个词法分析器，后面的文章中还会用到它。</p>

<p>相关资料</p>

<ul>
<li><p><a href="http://www.cnblogs.com/geniusvczh/p/3577561.html">跟vczh看实例学编译原理——二：实现Tinymoe的词法分析</a></p></li>
<li><p><a href="http://www.cnblogs.com/Ninputer/archive/2011/06/08/2075714.html">自己动手开发编译器（二）正则语言和正则表达式</a></p></li>
<li><p><a href="http://www.cnblogs.com/Ninputer/archive/2011/06/10/2077991.html">自己动手开发编译器（三）有穷自动机</a></p></li>
<li><p><a href="http://www.cnblogs.com/Ninputer/archive/2011/06/12/2078671.html">自己动手开发编译器（四）利用DFA转换表建立扫描器</a></p></li>
</ul>
            </div>
            <div class="">
                <p>Tags: 
                                            <a class="tag_a" href="../../tags/ngscript.html">ngscript</a>
                                                <a class="tag_a" href="../../tags/E8AF8DE6B395E58886E69E90.html">词法分析</a>
                                                <a class="tag_a" href="../../tags/E8AFADE8A880.html">语言</a>
                                        </p>
            </div>
            <!-- JiaThis Button BEGIN -->
            <div class="jiathis_style">
                <a class="jiathis_button_tsina"></a>
                <a class="jiathis_button_tqq"></a>
                <a class="jiathis_button_weixin"></a>
                <a class="jiathis_button_renren"></a>
                <a class="jiathis_button_douban"></a>
                <a class="jiathis_button_fb"></a>
                <a class="jiathis_button_googleplus"></a>
                <a class="jiathis_button_twitter"></a>
                <a class="jiathis_button_qzone"></a>
                <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank">更多</a>
            </div>
            <script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1394078030301326" charset="utf-8"></script>
            <!-- JiaThis Button END -->
        </div>
    </div>
    <div class="">
        <ul class="pager">
            <li class="pull-left"><a id="pre-post-archor" href="#">上一篇： <span id="pre-post-title"></span></a></li>
            <li class="pull-right"><a id="next-post-archor" href="#">下一篇： <span id="next-post-title"></span></a></li>
        </ul>
        <script>
            $(document).ready(function()
            {
                $.getJSON('../indexer.json', null, function(data)
                {
                    if (data instanceof Array)
                    {
                        for (i = 0; i < data.length; i++) {
                            if (data[i].sname === 'ngscript-part-2')
                            {
                                if (i !== 0)
                                {
                                    $('#pre-post-archor').attr('href', data[i - 1].url);
                                    $('#pre-post-title').text(data[i - 1].title);
                                } else {
                                    $('#pre-post-title').text('没有了');
                                }
                                if (i !== data.length - 1)
                                {
                                    $('#next-post-archor').attr('href', data[i + 1].url);
                                    $('#next-post-title').text(data[i + 1].title);
                                } else {
                                    $('#next-post-title').text('没有了');
                                }
                            }
                        }
                    }
                });
            });
        </script>
    </div>
    <div style="margin-left: 0px;">
        <!-- Duoshuo Comment BEGIN -->
        <div class="ds-thread" data-thread-key="ngscript-part-2/" data-title="ngscript之一：词法分析"></div>
        <script type="text/javascript">
            var duoshuoQuery = {short_name: "wssccc"};
            (function() {
                var ds = document.createElement('script');
                ds.type = 'text/javascript';
                ds.async = true;
                ds.src = 'http://static.duoshuo.com/embed.js';
                ds.charset = 'UTF-8';
                (document.getElementsByTagName('head')[0]
                        || document.getElementsByTagName('body')[0]).appendChild(ds);
            })();
        </script>
        <!-- Duoshuo Comment END -->
    </div>
                    <hr/>
                <div class="footer">
                    <p>Copyright &COPY;<a href="../../../blog/pages/about/">wssccc</a> 2013 using <a href="../../../blog/pages/about-generator/">wsc_blog_generator</a> <a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/deed.zh"><img class="no-fix-img" alt="知识共享许可协议" style="border-width:0" src="../../../assets/img/80x15.png" /></a></p>
                    <p>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/deed.zh">知识共享署名-禁止演绎 3.0 未本地化版本许可协议</a>进行许可。</p>
                </div>
            </div>
            <!-- Include all compiled plugins (below), or include individual files as needed -->
            <script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
            <script>
                $(document).ready(function() {
                    $('img').each(function()
                    {
                        if ($(this).hasClass('no-fix-img'))
                        {
                            return;
                        }
                        var src = $(this).attr('src');
                        if (src.match("http://") === null)
                        {
                            var real_url = '../../../blog/images/' + src;
                            $(this).attr('src', real_url);
                            $(this).addClass('user-image');
                            var archor = $('<a>');
                            archor.attr('href', real_url);
                            archor.attr('target', '_blank');

                            archor.insertBefore($(this));
                            $(this).appendTo(archor);
                        }
                    });

                });
            </script>
            <script>
                SyntaxHighlighter.all();
            </script>
        </body>
    </html>
    