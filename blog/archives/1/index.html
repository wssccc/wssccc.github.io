    <!DOCTYPE html>
    <html>
        <head>
            <title>wssccc</title>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta charset="utf-8">
            <!-- Bootstrap -->
            <link rel="stylesheet" href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap.min.css">
            <link rel="stylesheet" href="http://libs.baidu.com/bootstrap/3.0.3/css/bootstrap-theme.min.css">
            <link rel="stylesheet" href="../../../assets/css/custom.css">
            <!-- Favicon -->
            <link rel="shortcut icon" href="../../../assets/img/icon.png" />
            <link rel="favicon" href="../../../assets/img/icon.png" />
            <link rel="bookmark" href="../../../assets/img/icon.png" />
            <!--syntax hilighter-->
            <link rel="stylesheet" href="../../../assets/sh/styles/shCore.css">
            <link rel="stylesheet" href="../../../assets/sh/styles/shThemeDefault.css">
            <script src="../../../assets/sh/scripts/shCore.js"></script>
            <script src="../../../assets/sh/scripts/shBrushJScript.js"></script>
            <script src="../../../assets/sh/scripts/shBrushJava.js"></script>
            <script src="../../../assets/sh/scripts/shBrushXml.js"></script>

            <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
            <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
            <!--[if lt IE 9]>
                <script src="http://cdn.bootcss.com/html5shiv/3.7.0/html5shiv.min.js"></script>
                <script src="http://cdn.bootcss.com/respond.js/1.3.0/respond.min.js"></script>
            <![endif]-->

            <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
            <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
        </head>
        <body style="padding-top: 20px">
            <div class="container">
                <div class="site-heading-container">
                    <a class="site-heading" href="../../../">wssccc in action</a>
                    <a href="../../..//blog/rss.xml" rel="subscribe-rss" title="subscribe via RSS"><img src="../../../assets/img/atom.png" class="pull-right no-fix-img"></a>
                </div>
                    <div>
        <ol class="breadcrumb">
            <li><a href="../../../">wssccc</a></li>
            <li><a href="../../">archive</a></li>
        </ol>
    </div>
    <div id="posts" class="container">
                    <div class="archive">
                <div>
                    <a href="../../posts/ngscript-coroutine/" class="archive-heading">ngscript加入了coroutine支持</a>
                    <span class="time pull-right">2014-05-04 00:00</span>
                </div>
                <hr/>
                <div class="archive-content">
                    <h2>为什么使用协程</h2>

<p>在写ngscript的shell时遇到一点问题，于是想到了很久之前看过的lua的协程，觉得似乎有那么点意思。</p>

<p>问题是这样的，最开始ngscript版本中，是一次性读入全部文件的内容到一个字符串中，然后依次进行词法分析，</p>

<p>语法分析，得到AST之后拿AST去编译出虚拟机汇编。</p>

<p>后来因为要做shell，也就是一边输入一边进行编译的过程。因为输入有可能是不完全的，完整的程序可能分很多次发送过来，</p>

<p>这样，就需要有一个机制来判定什么时候该编译了。比如这样的输入</p>

<pre class="brush: java">

    function fn () { //回车1

        println("fn call"); //回车2

    } //回车3

</pre>

<p>正确的处理方式应该是，在回车1和回车2处提示用户继续输入，在回车3处进行编译过程。</p>

<p>最直观的方法是不停的尝试编译，如果出错则等待下一次输入。当然这个显然不行 = =</p>

<p>于是尝试把整个过程改成流，大概就是</p>

<blockquote>
  <p>字符流-> 词素流 -> AST流</p>
</blockquote>

<p>AST流的输出到编译部分，是以statement为单位的，因为statement貌似是最小可编译的结构。</p>

<p>运行起来之后，大概是这个样子。调用compile，compile向parser要AST，parser向lexer要token，lexer则向字符流要字符。</p>

<p>当某个环节产生可以返回的东西后，则传回到上一层执行。</p>

<p>因为会在字符流阻塞，于是整个compile过程需要一个单独的线程来跑。</p>

<p>这样问题又来了。在交互中输出信息（执行产生的一些东西和AST、ASM）是同步返回的，但是因为流需要阻塞又不得不使用线程，</p>

<p>所以又加了个同步锁。</p>

<p>写到这里我总感觉打开的方式似乎有问题……</p>

<p>我想到了协程。<a href="http://zh.wikipedia.org/zh-cn/%E5%8D%8F%E7%A8%8B">http://zh.wikipedia.org/zh-cn/%E5%8D%8F%E7%A8%8B</a></p>

<p>以前的lexer中的读字符是在一个大while中，当流返回eof的时候while退出。其它时间则在流的read函数处阻塞着。</p>

<p>正是这个read，让我不得不加入另外一个线程来跑它。</p>

<p>如果Java有协程的话，实际上可以这样来设计。</p>

<p>把lexer的读入过程创建为一个协程，在while中判断如果流不可用，则yield回去。</p>

<p>其他部分大抵也是如此。这样一来，整个过程（lex、parse、compile）又是同步的了。</p>

<p>当下一次有输入时，首先把输入的东西写进流，然后依次resume。yield回来的东西就是输出。</p>

<p>但是Java没有协程……我不得不把需要阻塞的函数改名成feed，然后把原来大while中的内部状态写到类成员中保存，使feed看起来是可重入的。</p>

<h2>ngscript中的协程</h2>

<p>ngscript中的协程实现是一个类。以一个函数为参数初始化，然后push进参数，就可以调用了。</p>

<p>命名也是参考了lua的resume,yield,status三个函数。</p>

<p>实现方式是，在resume中，把调用resume的frame，替换成调用函数的frame（主要是为了函数前面初始化形参变量的过程），</p>

<p>然后切换环境，进入函数执行。这里有个小trick是，栈顶返回地址写的不是resume的返回地址，而是一段特别为了hook return的代码的地址。</p>

<p>在这段代码中，会把当前coroutine的状态置为returned，然后再正常的返回。</p>

<p>而在yield中，主要是把当前代码地址保存下来，然后找到真实的返回地址返回。</p>

<p>ngscript关于coroutine的部分</p>

<p><a href="https://github.com/wssccc/ngscript/blob/master/README.md#coroutine">https://github.com/wssccc/ngscript/blob/master/README.md#coroutine</a></p>
                </div>
                <hr/>            </div>
                        <div class="archive">
                <div>
                    <a href="../../posts/ngscript-online-demo/" class="archive-heading">try ngscript online</a>
                    <span class="time pull-right">2014-04-29 22:55</span>
                </div>
                <hr/>
                <div class="archive-content">
                                    </div>
                            </div>
                        <div class="archive">
                <div>
                    <a href="../../posts/ngscript-part-4/" class="archive-heading">ngscript之三：语法设计</a>
                    <span class="time pull-right">2014-04-06 13:10</span>
                </div>
                <hr/>
                <div class="archive-content">
                                    </div>
                            </div>
                        <div class="archive">
                <div>
                    <a href="../../posts/ngscript-part-3/" class="archive-heading">﻿ngscript之二：语法分析</a>
                    <span class="time pull-right">2014-03-06 19:07</span>
                </div>
                <hr/>
                <div class="archive-content">
                                    </div>
                            </div>
                        <div class="archive">
                <div>
                    <a href="../../posts/ngscript-part-2/" class="archive-heading">ngscript之一：词法分析</a>
                    <span class="time pull-right">2014-03-04 13:35</span>
                </div>
                <hr/>
                <div class="archive-content">
                                    </div>
                            </div>
                        <div class="archive">
                <div>
                    <a href="../../posts/ngscript-part-1/" class="archive-heading">ngscript之零</a>
                    <span class="time pull-right">2014-03-04 12:04</span>
                </div>
                <hr/>
                <div class="archive-content">
                                    </div>
                            </div>
                        <div class="archive">
                <div>
                    <a href="../../posts/biscuit-of-the-year/" class="archive-heading">饼干君这一年</a>
                    <span class="time pull-right">2014-02-22 00:00</span>
                </div>
                <hr/>
                <div class="archive-content">
                                    </div>
                            </div>
                </div>
    <div class="">
        <ul class="pager">
            <li class="previous disabled"><a href="javascript:void(0)">&larr; Previous</a></li>
            <li class="next "><a href="../2/">Next &rarr;</a></li>
        </ul>
    </div>
                    <hr/>
                <div class="footer">
                    <p>Copyright &COPY;<a href="../../../blog/pages/about/">wssccc</a> 2013 using <a href="../../../blog/pages/about-generator/">wsc_blog_generator</a> <a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/deed.zh"><img class="no-fix-img" alt="知识共享许可协议" style="border-width:0" src="../../../assets/img/80x15.png" /></a></p>
                    <p>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nd/3.0/deed.zh">知识共享署名-禁止演绎 3.0 未本地化版本许可协议</a>进行许可。</p>
                </div>
            </div>
            <!-- Include all compiled plugins (below), or include individual files as needed -->
            <script src="http://libs.baidu.com/bootstrap/3.0.3/js/bootstrap.min.js"></script>
            <script>
                $(document).ready(function() {
                    $('img').each(function()
                    {
                        if ($(this).hasClass('no-fix-img'))
                        {
                            return;
                        }
                        var src = $(this).attr('src');
                        if (src.match("http://") === null)
                        {
                            var real_url = '../../../blog/images/' + src;
                            $(this).attr('src', real_url);
                            $(this).addClass('user-image');
                            var archor = $('<a>');
                            archor.attr('href', real_url);
                            archor.attr('target', '_blank');

                            archor.insertBefore($(this));
                            $(this).appendTo(archor);
                        }
                    });

                });
            </script>
            <script>
                SyntaxHighlighter.all();
            </script>
        </body>
    </html>
    